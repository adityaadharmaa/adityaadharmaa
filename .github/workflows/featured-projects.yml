name: Update Featured Projects

on:
  schedule:
    - cron: "0 0 * * *"   # jalan tiap hari 00:00 UTC
  workflow_dispatch:       # bisa run manual
  push:
    branches: ["main"]     # juga jalan saat ada push ke main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Featured Projects (latest 3 public repos)
        uses: actions/github-script@v7
        id: gen
        with:
         script: |
            const owner = context.repo.owner;

            const query = `
              query($login: String!) {
                repositoryOwner(login: $login) {
                  repositories(
                    first: 12
                    privacy: PUBLIC
                    isFork: false
                    orderBy: { field: PUSHED_AT, direction: DESC }
                  ) {
                    nodes {
                      name
                      description
                      url
                      updatedAt
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(query, { login: owner });
            const repos = (data.repositoryOwner.repositories.nodes || []).slice(0, 3);

            // Hilangkan indent kiri supaya HTML tidak dianggap code block
            function stripLeft(s) {
              return s.split('\n').map(line => line.replace(/^\s+/, '')).join('\n').trim();
            }

            // ===== KARTU GAMBAR ALA PINNED (dinamis) =====
            function card(r) {
                  const src =
                    "https://github-readme-stats.vercel.app/api/pin/?username="
                    + owner
                    + "&repo="
                    + encodeURIComponent(r.name)
                    + "&theme=tokyonight"
                    + "&cache_seconds=1800";
                
                  let html = '';
                  html += '<a href="' + r.url + '">\n';
                  html += '  <img src="' + src + '" alt="' + r.name + ' card" />\n';
                  html += '</a>';
                  return stripLeft(html);
                }

            const grid = stripLeft(
              '<div align="center">\n'
              + repos.map(card).join('\n')
              + '\n</div>'
            );

            const fs = require('fs');
            const PATH = './README.md';
            const START = '<!-- FEATURED:START -->';
            const END   = '<!-- FEATURED:END -->';
            const readme = fs.readFileSync(PATH, 'utf8');
            const regex = new RegExp(START + '[\\s\\S]*?' + END);
            const next  = START + '\n' + grid + '\n' + END;

            if (!regex.test(readme)) {
              core.setFailed('Markers not found in README.md (FEATURED:START/END)');
            } else {
              const updated = readme.replace(regex, next);
              fs.writeFileSync(PATH, updated);
              core.setOutput('updated', 'true');
            }
      - name: Commit changes
        if: steps.gen.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: auto-update featured projects (latest 3)" && git push)
