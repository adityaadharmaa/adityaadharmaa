name: Update Featured Projects

on:
  schedule:
    # 00:00 WITA = 16:00 UTC
    - cron: '0 16 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-featured:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Featured Projects
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // GitHub Readme Stats self-hosted
            const STATS_BASE = "https://github-readme-stats-seven-theta-91.vercel.app";
            const owner = context.repo.owner;

            // Ambil 3 repo terakhir yang aktif (bukan fork)
            const { data } = await github.rest.search.repos({
              q: `user:${owner} fork:false`,
              sort: 'updated',
              order: 'desc',
              per_page: 3
            });

            function renderCard(repo) {
              const img = `${STATS_BASE}/api/pin/?username=${owner}&repo=${repo.name}&theme=tokyonight`;
              return `
                <a href="${repo.html_url}">
                  <img src="${img}" height="120" loading="lazy" />
                </a>`;
            }

            const featuredContent = `
            <div align="center">
            ${data.items.map(renderCard).join('\n')}
            </div>
            `.trim();

            const readmePath = 'README.md';
            const readme = fs.readFileSync(readmePath, 'utf8');

            const startMarker = '<!-- FEATURED_PROJECTS_START -->';
            const endMarker = '<!-- FEATURED_PROJECTS_END -->';

            const markerRegex = new RegExp(
              `${startMarker}[\\s\\S]*?${endMarker}`,
              'm'
            );

            if (!markerRegex.test(readme)) {
              throw new Error(
                '❌ Marker FEATURED_PROJECTS tidak ditemukan di README.md'
              );
            }

            const updatedReadme = readme.replace(
              markerRegex,
              `${startMarker}\n${featuredContent}\n${endMarker}`
            );

            if (updatedReadme !== readme) {
              fs.writeFileSync(readmePath, updatedReadme);
              console.log('✅ Featured Projects berhasil di-update');
            } else {
              console.log('ℹ️ Tidak ada perubahan pada Featured Projects');
            }

      - name: Commit and Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update featured projects (auto)" || exit 0
          git push
