name: Update Featured Projects (Safe & WITA)

on:
  # Jalan otomatis 1x sehari (00:30 WITA)
  schedule:
    - cron: "30 16 * * *"   # 16:30 UTC = 00:30 WITA

  # Bisa dijalankan manual dari GitHub UI
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-featured:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Featured Projects (latest 3 public repos)
        uses: actions/github-script@v7
        id: gen
        with:
          script: |
            const owner = context.repo.owner;

            const query = `
              query ($login: String!) {
                repositoryOwner(login: $login) {
                  repositories(
                    first: 12
                    privacy: PUBLIC
                    isFork: false
                    orderBy: { field: PUSHED_AT, direction: DESC }
                  ) {
                    nodes {
                      name
                      description
                      url
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(query, { login: owner });
            const repos = (data.repositoryOwner.repositories.nodes || [])
              .filter(r => r.description) // ðŸ” hanya repo yang punya description
              .slice(0, 3);

            function stripLeft(s) {
              return s
                .split('\n')
                .map(line => line.replace(/^\s+/, ''))
                .join('\n')
                .trim();
            }

            function card(repo) {
              const STATS_BASE = "https://github-readme-stats-seven-theta-91.vercel.app";

              const src =
                STATS_BASE
                + "/api/pin/?username="
                + owner
                + "&repo="
                + encodeURIComponent(repo.name)
                + "&theme=tokyonight";

              return stripLeft(`
                <a href="${repo.url}">
                  <img src="${src}" alt="${repo.name} card" loading="lazy" />
                </a>
              `);
            }

            const grid = stripLeft(`
              <div align="center">
                ${repos.map(card).join('\n')}
              </div>
            `);

            const fs = require('fs');
            const PATH = './README.md';
            const START = '<!-- FEATURED:START -->';
            const END   = '<!-- FEATURED:END -->';

            const readme = fs.readFileSync(PATH, 'utf8');
            const regex = new RegExp(`${START}[\\s\\S]*?${END}`);

            if (!regex.test(readme)) {
              core.setFailed('FEATURED markers not found in README.md');
              return;
            }

            const next = `${START}\n${grid}\n${END}`;
            const updated = readme.replace(regex, next);

            if (updated !== readme) {
              fs.writeFileSync(PATH, updated);
              core.setOutput('updated', 'true');
            } else {
              core.setOutput('updated', 'false');
            }

      - name: Commit changes
        if: steps.gen.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update featured projects (daily, WITA)"
          git push
